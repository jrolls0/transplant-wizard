<%- include('partials/header', {title: 'Patient Documents'}) %>

<!-- Page Header -->
<section class="page-header bg-light py-4">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Patient Documents</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 fw-bold mb-1">Patient Documents</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-user me-2"></i>
                    <%= patient.first_name %> <%= patient.last_name %>
                    <% if (patient.email) { %>
                        <span class="mx-2">|</span>
                        <i class="fas fa-envelope me-1"></i><%= patient.email %>
                    <% } %>
                </p>
            </div>
            <a href="/dashboard" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</section>

<!-- Documents Section -->
<section class="documents-section py-5">
    <div class="container">
        <% if (documents && documents.length > 0) { %>
            <div class="row g-4">
                <% 
                const docTypeNames = {
                    'insurance_card': { name: 'Insurance Card', icon: 'fa-id-card', color: 'primary' },
                    'medication_list': { name: 'Medication List', icon: 'fa-pills', color: 'success' },
                    'government_id': { name: 'Government ID', icon: 'fa-address-card', color: 'info' },
                    'medical_records': { name: 'Medical Records', icon: 'fa-file-medical', color: 'warning' },
                    'lab_results': { name: 'Lab Results', icon: 'fa-flask', color: 'danger' },
                    'referral_letter': { name: 'Referral Letter', icon: 'fa-envelope-open-text', color: 'secondary' },
                    'other': { name: 'Other Document', icon: 'fa-file', color: 'dark' }
                };
                
                Object.keys(groupedDocs).forEach(docType => {
                    const docs = groupedDocs[docType];
                    const typeInfo = docTypeNames[docType] || docTypeNames['other'];
                %>
                    <div class="col-12">
                        <div class="modern-card">
                            <div class="card-header border-0 bg-transparent">
                                <div class="d-flex align-items-center">
                                    <div class="doc-type-icon bg-<%= typeInfo.color %> bg-opacity-10 text-<%= typeInfo.color %> me-3">
                                        <i class="fas <%= typeInfo.icon %>"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title mb-0 fw-bold"><%= typeInfo.name %></h5>
                                        <small class="text-muted"><%= docs.length %> file<%= docs.length > 1 ? 's' : '' %></small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <% docs.forEach(doc => { %>
                                        <div class="col-md-6 col-lg-4">
                                            <div class="document-card p-3 rounded border">
                                                <div class="d-flex align-items-start justify-content-between">
                                                    <div class="d-flex align-items-center">
                                                        <div class="file-icon me-3">
                                                            <% if (doc.mime_type && doc.mime_type.includes('pdf')) { %>
                                                                <i class="fas fa-file-pdf fa-2x text-danger"></i>
                                                            <% } else { %>
                                                                <i class="fas fa-file-image fa-2x text-primary"></i>
                                                            <% } %>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-1 fw-medium">
                                                                <% if (docType === 'insurance_card') { %>
                                                                    <%= doc.is_front ? 'Front' : 'Back' %> Side
                                                                <% } else { %>
                                                                    <%= doc.file_name %>
                                                                <% } %>
                                                            </h6>
                                                            <small class="text-muted d-block">
                                                                <% if (doc.file_size) { %>
                                                                    <%= (doc.file_size / 1024).toFixed(1) %> KB
                                                                <% } %>
                                                            </small>
                                                            <small class="text-muted">
                                                                <%= new Date(doc.created_at).toLocaleDateString('en-US', { 
                                                                    month: 'short', 
                                                                    day: 'numeric', 
                                                                    year: 'numeric',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                }) %>
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-primary view-doc-btn" 
                                                            data-doc-id="<%= doc.id %>"
                                                            title="View Document">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-folder-open fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted">No Documents Uploaded</h4>
                    <p class="text-muted">This patient has not uploaded any documents yet.</p>
                    <a href="/dashboard" class="btn btn-primary mt-3">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        <% } %>
    </div>
</section>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="documentModalLabel">Document Viewer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div id="docLoadingSpinner" class="py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-3">Loading document...</p>
                </div>
                <div id="docContent" style="display: none;">
                    <img id="docImage" src="" alt="Document" class="img-fluid rounded shadow" style="max-height: 70vh;">
                    <iframe id="docPdf" src="" style="width: 100%; height: 70vh; display: none;" frameborder="0"></iframe>
                </div>
                <div id="docError" style="display: none;" class="text-danger py-5">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>Failed to load document. Please try again.</p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <a id="docDownloadLink" href="#" target="_blank" class="btn btn-primary" download>
                    <i class="fas fa-download me-2"></i>Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    border-bottom: 1px solid var(--border-color);
}

.modern-card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: none;
}

.doc-type-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.document-card {
    background: #f8fafc;
    transition: all 0.3s ease;
}

.document-card:hover {
    background: #f1f5f9;
    border-color: var(--primary-color) !important;
}

.file-icon {
    width: 40px;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

/* HIPAA Notice */
.hipaa-notice {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #f59e0b;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewButtons = document.querySelectorAll('.view-doc-btn');
    const modal = new bootstrap.Modal(document.getElementById('documentModal'));
    
    viewButtons.forEach(btn => {
        btn.addEventListener('click', async function() {
            const docId = this.dataset.docId;
            const buttonElement = this;
            const documentCard = buttonElement.closest('.col-md-6');
            
            // Show modal with loading state
            document.getElementById('docLoadingSpinner').style.display = 'block';
            document.getElementById('docContent').style.display = 'none';
            document.getElementById('docError').style.display = 'none';
            modal.show();
            
            try {
                const response = await fetch(`/api/documents/${docId}/url`);
                const data = await response.json();
                
                if (data.success && data.url) {
                    document.getElementById('docLoadingSpinner').style.display = 'none';
                    document.getElementById('docContent').style.display = 'block';
                    
                    // Check if PDF or image
                    if (data.url.includes('.pdf')) {
                        document.getElementById('docImage').style.display = 'none';
                        document.getElementById('docPdf').style.display = 'block';
                        document.getElementById('docPdf').src = data.url;
                    } else {
                        document.getElementById('docPdf').style.display = 'none';
                        document.getElementById('docImage').style.display = 'block';
                        document.getElementById('docImage').src = data.url;
                    }
                    
                    document.getElementById('docDownloadLink').href = data.url;
                } else if (data.deleted) {
                    // Document was deleted from S3 - remove from page
                    modal.hide();
                    if (documentCard) {
                        documentCard.remove();
                        // Show notification
                        showToast('Document no longer exists and has been removed.', 'warning');
                    }
                } else {
                    throw new Error('Failed to get document URL');
                }
            } catch (error) {
                console.error('Error loading document:', error);
                document.getElementById('docLoadingSpinner').style.display = 'none';
                document.getElementById('docError').style.display = 'block';
            }
        });
    });
    
    // Toast notification helper
    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'warning' ? 'warning' : 'primary'} border-0 position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = document.body.lastElementChild;
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }
});
</script>

<%- include('partials/footer') %>
