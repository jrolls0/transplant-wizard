<%- include('partials/header', {title: title}) %>

<div class="container-fluid px-4 py-4" style="background: #f8fafc; min-height: calc(100vh - 150px);">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h1 class="h3 fw-bold mb-1" style="color: #111827;">
                                <i class="fas fa-users me-2" style="color: #6366f1;"></i>Patient Management
                            </h1>
                            <p class="mb-0" style="color: #4b5563;">Track referrals and registered patients</p>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge fs-6 px-3 py-2" style="background: #fef3c7; color: #92400e;">
                                <i class="fas fa-paper-plane me-1"></i><%= pendingReferrals.length %> pending
                            </span>
                            <span class="badge fs-6 px-3 py-2" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                                <i class="fas fa-user-check me-1"></i><%= allPatients.length %> registered
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs + Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <!-- 4 Filter Tabs -->
                        <div class="d-flex flex-wrap gap-2" id="filterTabs">
                            <button type="button" class="btn filter-tab active" data-filter="all" style="border-radius: 20px; padding: 0.5rem 1.25rem; font-weight: 600;">
                                <i class="fas fa-users me-1"></i>All Patients 
                                <span class="badge bg-white text-dark ms-1"><%= pendingReferrals.length + allPatients.length %></span>
                            </button>
                            <button type="button" class="btn filter-tab" data-filter="pending" style="border-radius: 20px; padding: 0.5rem 1.25rem; font-weight: 600;">
                                <i class="fas fa-clock me-1"></i>Pending Referrals 
                                <span class="badge bg-secondary ms-1"><%= pendingReferrals.length %></span>
                            </button>
                            <button type="button" class="btn filter-tab" data-filter="registered" style="border-radius: 20px; padding: 0.5rem 1.25rem; font-weight: 600;">
                                <i class="fas fa-user-plus me-1"></i>Registered 
                                <span class="badge bg-secondary ms-1"><%= stageCounts.registered + stageCounts.roi_signed + stageCounts.tc_selected + stageCounts.documents %></span>
                            </button>
                            <button type="button" class="btn filter-tab" data-filter="complete" style="border-radius: 20px; padding: 0.5rem 1.25rem; font-weight: 600;">
                                <i class="fas fa-check-circle me-1"></i>Complete 
                                <span class="badge bg-secondary ms-1"><%= stageCounts.complete %></span>
                            </button>
                        </div>
                        <!-- Search -->
                        <div class="position-relative" style="min-width: 250px;">
                            <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                            <input type="text" class="form-control ps-5" id="patientSearch" placeholder="Search by name or email..." style="border-radius: 8px; border: 1px solid #d1d5db;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Patients Table -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="patientsTable">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th class="border-0 text-muted small text-uppercase ps-4" style="font-weight: 600; letter-spacing: 0.5px;">Patient</th>
                                    <th class="border-0 text-muted small text-uppercase" style="font-weight: 600; letter-spacing: 0.5px;">Contact</th>
                                    <th class="border-0 text-muted small text-uppercase text-center" style="font-weight: 600; letter-spacing: 0.5px;">Status</th>
                                    <th class="border-0 text-muted small text-uppercase" style="font-weight: 600; letter-spacing: 0.5px;">Date</th>
                                    <th class="border-0 text-muted small text-uppercase text-end pe-4" style="font-weight: 600; letter-spacing: 0.5px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <!-- Pending Referrals -->
                                <% pendingReferrals.forEach(function(referral) { %>
                                    <tr class="patient-row" data-type="pending" data-id="<%= referral.id %>" data-name="<%= referral.patient_first_name %> <%= referral.patient_last_name %>" data-email="<%= referral.patient_email %>">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                     style="width: 40px; height: 40px; background: #fef3c7; color: #92400e; font-weight: 600; font-size: 0.875rem;">
                                                    <%= referral.patient_first_name ? referral.patient_first_name.charAt(0) : '' %><%= referral.patient_last_name ? referral.patient_last_name.charAt(0) : '' %>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-semibold patient-name" style="color: #1f2937;"><%= referral.patient_first_name %> <%= referral.patient_last_name %></h6>
                                                    <span class="badge" style="background: #fef3c7; color: #92400e; font-size: 0.65rem;">
                                                        <i class="fas fa-clock me-1"></i>Awaiting Registration
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small patient-email" style="color: #4b5563;"><i class="fas fa-envelope me-1 text-muted"></i><%= referral.patient_email %></div>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge" style="background: #fef3c7; color: #92400e;">
                                                <i class="fas fa-paper-plane me-1"></i>Pending
                                            </span>
                                            <div class="small mt-1">
                                                <span class="badge <%= referral.daysPending > 7 ? 'bg-danger' : referral.daysPending > 3 ? 'bg-warning' : 'bg-info' %>" style="font-size: 0.65rem;">
                                                    <%= referral.daysPending %> days
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <small style="color: #6b7280;">Referred <%= new Date(referral.created_at).toLocaleDateString() %></small>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-resend" data-id="<%= referral.id %>" title="Resend Invitation">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-cancel" data-id="<%= referral.id %>" data-name="<%= referral.patient_first_name %> <%= referral.patient_last_name %>" title="Cancel Referral">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                                
                                <!-- Registered Patients -->
                                <% patients.forEach(function(patient) { %>
                                    <tr class="patient-row" data-type="<%= patient.stage === 'complete' ? 'complete' : 'registered' %>" data-name="<%= patient.first_name %> <%= patient.last_name %>" data-email="<%= patient.email %>">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                     style="width: 40px; height: 40px; background: <%= patient.stage === 'complete' ? 'linear-gradient(135deg, #059669 0%, #10b981 100%)' : 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' %>; color: white; font-weight: 600; font-size: 0.875rem;">
                                                    <%= patient.first_name ? patient.first_name.charAt(0) : '' %><%= patient.last_name ? patient.last_name.charAt(0) : '' %>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-semibold patient-name" style="color: #1f2937;"><%= patient.first_name %> <%= patient.last_name %></h6>
                                                    <% if (patient.date_of_birth) { %>
                                                        <small class="text-muted">DOB: <%= new Date(patient.date_of_birth).toLocaleDateString() %></small>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small">
                                                <div class="patient-email" style="color: #4b5563;"><i class="fas fa-envelope me-1 text-muted"></i><%= patient.email %></div>
                                                <% if (patient.phone_number) { %>
                                                    <div style="color: #4b5563;"><i class="fas fa-phone me-1 text-muted"></i><%= patient.phone_number %></div>
                                                <% } %>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge" style="background: <%= patient.stageColor %>20; color: <%= patient.stageColor %>;">
                                                <% if (patient.stage === 'registered') { %>
                                                    <i class="fas fa-user-plus me-1"></i>
                                                <% } else if (patient.stage === 'roi_signed') { %>
                                                    <i class="fas fa-file-signature me-1"></i>
                                                <% } else if (patient.stage === 'tc_selected') { %>
                                                    <i class="fas fa-hospital me-1"></i>
                                                <% } else if (patient.stage === 'documents') { %>
                                                    <i class="fas fa-file-alt me-1"></i>
                                                <% } else if (patient.stage === 'complete') { %>
                                                    <i class="fas fa-check-circle me-1"></i>
                                                <% } %>
                                                <%= patient.stageLabel %>
                                            </span>
                                        </td>
                                        <td>
                                            <small style="color: #6b7280;">Registered <%= new Date(patient.created_at).toLocaleDateString() %></small>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group btn-group-sm">
                                                <a href="/patients/<%= patient.patient_id %>" class="btn btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-secondary btn-contact" data-email="<%= patient.email %>" title="Contact">
                                                    <i class="fas fa-envelope"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <div class="mb-3">
                            <i class="fas fa-users fa-3x" style="color: #9ca3af;"></i>
                        </div>
                        <h5 style="color: #374151;">No Patients Found</h5>
                        <p style="color: #6b7280;" class="mb-3" id="emptyMessage">No patients match your search or filter.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.filter-tab {
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    color: #374151;
    transition: all 0.2s ease;
}
.filter-tab:hover {
    background: #e5e7eb;
    border-color: #d1d5db;
    color: #1f2937;
}
.filter-tab.active {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-color: #6366f1;
    color: white;
}
.filter-tab.active .badge {
    background: white !important;
    color: #6366f1 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var currentFilter = 'all';
    var searchInput = document.getElementById('patientSearch');
    var filterTabs = document.querySelectorAll('.filter-tab');
    var rows = document.querySelectorAll('#patientsTableBody .patient-row');
    var emptyState = document.getElementById('emptyState');
    var emptyMessage = document.getElementById('emptyMessage');
    
    // Filter function
    function applyFilters() {
        var searchTerm = searchInput.value.toLowerCase().trim();
        var visibleCount = 0;
        
        rows.forEach(function(row) {
            var rowType = row.getAttribute('data-type');
            var name = (row.getAttribute('data-name') || '').toLowerCase();
            var email = (row.getAttribute('data-email') || '').toLowerCase();
            
            // Check filter match
            var filterMatch = false;
            if (currentFilter === 'all') {
                filterMatch = true;
            } else if (currentFilter === 'pending' && rowType === 'pending') {
                filterMatch = true;
            } else if (currentFilter === 'registered' && rowType === 'registered') {
                filterMatch = true;
            } else if (currentFilter === 'complete' && rowType === 'complete') {
                filterMatch = true;
            }
            
            // Check search match
            var searchMatch = !searchTerm || name.includes(searchTerm) || email.includes(searchTerm);
            
            if (filterMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        if (visibleCount === 0) {
            emptyState.style.display = 'block';
            if (searchTerm) {
                emptyMessage.textContent = 'No patients match your search "' + searchTerm + '".';
            } else {
                emptyMessage.textContent = 'No patients in this category.';
            }
        } else {
            emptyState.style.display = 'none';
        }
    }
    
    // Tab click handlers
    filterTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
            filterTabs.forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            currentFilter = this.getAttribute('data-filter');
            applyFilters();
        });
    });
    
    // Search input handler
    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
    }
    
    // Resend button handlers
    document.querySelectorAll('.btn-resend').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var referralId = this.getAttribute('data-id');
            if (!confirm('Resend invitation email to this patient?')) return;
            
            fetch('https://api.transplantwizard.com/api/v1/dusw/referrals/' + referralId + '/resend', {
                method: 'POST',
                credentials: 'include'
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    alert('Invitation resent successfully!');
                } else {
                    alert('Failed to resend: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Failed to resend invitation. Please try again.');
            });
        });
    });
    
    // Cancel button handlers
    document.querySelectorAll('.btn-cancel').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var referralId = this.getAttribute('data-id');
            var patientName = this.getAttribute('data-name');
            if (!confirm('Are you sure you want to cancel the referral for ' + patientName + '? This cannot be undone.')) return;
            
            fetch('https://api.transplantwizard.com/api/v1/dusw/referrals/' + referralId, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    var row = document.querySelector('tr[data-id="' + referralId + '"]');
                    if (row) row.remove();
                    alert('Referral canceled successfully.');
                    location.reload();
                } else {
                    alert('Failed to cancel: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Failed to cancel referral. Please try again.');
            });
        });
    });
    
    // Contact button handlers
    document.querySelectorAll('.btn-contact').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var email = this.getAttribute('data-email');
            window.location.href = 'mailto:' + email;
        });
    });
});
</script>

<%- include('partials/footer') %>
