<%- include('partials/header', {title: title}) %>

<!-- Main Dashboard Container -->
<div class="container-fluid px-4 py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h3 fw-bold mb-1" style="color: #1f2937;">
                        Welcome back, <%= user.title %> <%= user.firstName %>!
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-hospital me-1"></i><%= user.dialysisClinic %>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#referralModal">
                        <i class="fas fa-user-plus me-2"></i>Refer New Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Total Patients -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
                <div class="card-body p-4 text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-white-50 mb-1 text-uppercase small fw-semibold" style="letter-spacing: 0.5px;">Total Patients</p>
                            <h2 class="display-4 fw-bold mb-0"><%= stats.totalPatients %></h2>
                            <p class="mb-0 mt-2 small text-white-50">Assigned to you</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-users fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TC Selection Rate -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 16px;">
                <div class="card-body p-4 text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-white-50 mb-1 text-uppercase small fw-semibold" style="letter-spacing: 0.5px;">TC Selection Rate</p>
                            <h2 class="display-4 fw-bold mb-0"><%= stats.tcSelectionPercent %>%</h2>
                            <p class="mb-0 mt-2 small text-white-50"><%= stats.patientsWithTC %> of <%= stats.totalPatients %> selected</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-hospital fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Breakdown -->
        <div class="col-lg-4 col-md-12">
            <div class="card border-0 h-100" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <p class="text-muted mb-3 text-uppercase small fw-semibold" style="letter-spacing: 0.5px;">
                        <i class="fas fa-chart-pie me-2" style="color: #667eea;"></i>Patient Status Breakdown
                    </p>
                    <div class="row text-center g-2">
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: rgba(251, 191, 36, 0.1);">
                                <h4 class="fw-bold mb-0" style="color: #f59e0b;"><%= stats.statusCounts.applied %></h4>
                                <small class="text-muted" style="font-size: 0.7rem;">Applied</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: rgba(59, 130, 246, 0.1);">
                                <h4 class="fw-bold mb-0" style="color: #3b82f6;"><%= stats.statusCounts.under_review %></h4>
                                <small class="text-muted" style="font-size: 0.7rem;">Review</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: rgba(16, 185, 129, 0.1);">
                                <h4 class="fw-bold mb-0" style="color: #10b981;"><%= stats.statusCounts.accepted %></h4>
                                <small class="text-muted" style="font-size: 0.7rem;">Accepted</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: rgba(139, 92, 246, 0.1);">
                                <h4 class="fw-bold mb-0" style="color: #8b5cf6;"><%= stats.statusCounts.waitlisted %></h4>
                                <small class="text-muted" style="font-size: 0.7rem;">Waitlist</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: rgba(239, 68, 68, 0.1);">
                                <h4 class="fw-bold mb-0" style="color: #ef4444;"><%= stats.statusCounts.declined %></h4>
                                <small class="text-muted" style="font-size: 0.7rem;">Declined</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: rgba(107, 114, 128, 0.1);">
                                <h4 class="fw-bold mb-0" style="color: #6b7280;"><%= stats.statusCounts.no_selection %></h4>
                                <small class="text-muted" style="font-size: 0.7rem;">Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="fw-bold mb-3" style="color: #374151;"><i class="fas fa-bolt me-2" style="color: #667eea;"></i>Quick Actions</h5>
            <div class="d-flex gap-3 flex-wrap">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#referralModal">
                    <i class="fas fa-user-plus me-2"></i>Refer New Patient
                </button>
                <a href="/patients" class="btn btn-outline-secondary">
                    <i class="fas fa-users me-2"></i>View All Patients
                </a>
                <button class="btn btn-outline-secondary" disabled title="Coming Soon">
                    <i class="fas fa-envelope me-2"></i>Send Message to Patient
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Patients Table -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0" style="border-radius: 16px;">
                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #374151;">
                            <i class="fas fa-users me-2" style="color: #667eea;"></i>Your Patients
                        </h5>
                        <a href="/patients" class="btn btn-sm btn-outline-primary">
                            View All <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <% if (patients && patients.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr style="border-bottom: 2px solid #e5e7eb;">
                                        <th class="border-0 text-muted small text-uppercase" style="font-weight: 600; letter-spacing: 0.5px;">Patient</th>
                                        <th class="border-0 text-muted small text-uppercase" style="font-weight: 600; letter-spacing: 0.5px;">Contact</th>
                                        <th class="border-0 text-muted small text-uppercase text-center" style="font-weight: 600; letter-spacing: 0.5px;">TC Status</th>
                                        <th class="border-0 text-muted small text-uppercase" style="font-weight: 600; letter-spacing: 0.5px;">Registered</th>
                                        <th class="border-0 text-muted small text-uppercase text-end" style="font-weight: 600; letter-spacing: 0.5px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% patients.slice(0, 10).forEach(patient => { %>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                                                        <%= patient.first_name ? patient.first_name.charAt(0) : '' %><%= patient.last_name ? patient.last_name.charAt(0) : '' %>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0 fw-semibold" style="color: #1f2937;"><%= patient.first_name %> <%= patient.last_name %></h6>
                                                        <% if (patient.date_of_birth) { %>
                                                            <small class="text-muted">DOB: <%= new Date(patient.date_of_birth).toLocaleDateString() %></small>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="small">
                                                    <div style="color: #4b5563;"><i class="fas fa-envelope me-1 text-muted"></i><%= patient.email %></div>
                                                    <% if (patient.phone_number) { %>
                                                        <div style="color: #4b5563;"><i class="fas fa-phone me-1 text-muted"></i><%= patient.phone_number %></div>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <% if (parseInt(patient.referral_count) > 0) { %>
                                                    <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                                        <i class="fas fa-check-circle me-1"></i><%= patient.referral_count %> TC Selected
                                                    </span>
                                                <% } else { %>
                                                    <span class="badge" style="background: rgba(251, 191, 36, 0.1); color: #f59e0b;">
                                                        <i class="fas fa-clock me-1"></i>Pending Selection
                                                    </span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <small style="color: #6b7280;"><%= new Date(patient.created_at).toLocaleDateString() %></small>
                                            </td>
                                            <td class="text-end">
                                                <a href="/patients/<%= patient.patient_id %>" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-users fa-3x" style="color: #d1d5db;"></i>
                            </div>
                            <h5 class="text-muted">No Patients Yet</h5>
                            <p class="text-muted mb-3">Refer your first patient to get started.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#referralModal">
                                <i class="fas fa-user-plus me-2"></i>Refer New Patient
                            </button>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Referral Modal -->
<div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div>
                    <h5 class="modal-title text-white fw-bold mb-0" id="referralModalLabel">
                        <i class="fas fa-user-plus me-2"></i>Refer a New Patient
                    </h5>
                    <small class="text-white-50">Invite a patient to join Transplant Wizard</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="referralForm">
                    <div id="successAlert" class="alert alert-success d-none">
                        <i class="fas fa-check-circle me-2"></i>Referral sent successfully!
                    </div>
                    <div id="errorAlert" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-circle me-2"></i><span id="errorMessage"></span>
                    </div>

                    <h6 class="fw-bold mb-3" style="color: #374151;">Patient Information</h6>
                    
                    <div class="mb-3">
                        <label for="patientTitle" class="form-label small fw-semibold">Title (Optional)</label>
                        <select class="form-select form-select-sm" id="patientTitle" name="patientTitle">
                            <option value="">Select title...</option>
                            <option value="Mr">Mr</option>
                            <option value="Mrs">Mrs</option>
                            <option value="Ms">Ms</option>
                            <option value="Dr">Dr</option>
                        </select>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="patientFirstName" class="form-label small fw-semibold">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="patientFirstName" name="patientFirstName" required>
                        </div>
                        <div class="col-6">
                            <label for="patientLastName" class="form-label small fw-semibold">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="patientLastName" name="patientLastName" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="patientEmail" class="form-label small fw-semibold">Email Address <span class="text-danger">*</span></label>
                        <input type="email" class="form-control form-control-sm" id="patientEmail" name="patientEmail" required>
                    </div>

                    <div class="mb-3">
                        <label for="patientNephrologist" class="form-label small fw-semibold">Nephrologist (Optional)</label>
                        <input type="text" class="form-control form-control-sm" id="patientNephrologist" name="patientNephrologist" placeholder="Dr. Smith">
                    </div>

                    <!-- Hidden Fields -->
                    <input type="hidden" id="dialysisClinicId" name="dialysisClinicId" value="<%= user.dialysisClinicId || '' %>">
                    <input type="hidden" id="dialysisClinic" name="dialysisClinic" value="<%= user.dialysisClinic %>">
                    <input type="hidden" id="duswId" name="duswId" value="<%= user.id %>">
                    <input type="hidden" id="duswEmail" name="duswEmail" value="<%= user.email %>">
                    <input type="hidden" id="duswName" name="duswName" value="<%= user.firstName %> <%= user.lastName %>">
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReferral" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    <i class="fas fa-paper-plane me-2"></i><span id="submitText">Send Referral</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check" style="font-size: 36px; color: white;"></i>
                    </div>
                </div>
                <h4 class="fw-bold mb-3">Referral Sent!</h4>
                <p class="text-muted mb-1">Patient referral created for:</p>
                <p class="fw-semibold mb-1" id="successModalPatientName"></p>
                <p class="text-muted mb-4" id="successModalPatientEmail"></p>
                <button type="button" class="btn btn-primary px-4" id="successDoneBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const referralForm = document.getElementById('referralForm');
    const submitButton = document.getElementById('submitReferral');
    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const submitText = document.getElementById('submitText');

    if (submitButton) {
        submitButton.addEventListener('click', async function(e) {
            e.preventDefault();
            
            successAlert.classList.add('d-none');
            errorAlert.classList.add('d-none');

            if (!referralForm.checkValidity()) {
                referralForm.reportValidity();
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

            try {
                const formData = {
                    patientTitle: document.getElementById('patientTitle').value || null,
                    patientFirstName: document.getElementById('patientFirstName').value,
                    patientLastName: document.getElementById('patientLastName').value,
                    patientEmail: document.getElementById('patientEmail').value,
                    patientNephrologist: document.getElementById('patientNephrologist').value || null,
                    dialysisClinicId: document.getElementById('dialysisClinicId').value,
                    dialysisClinicName: document.getElementById('dialysisClinic').value,
                    duswId: document.getElementById('duswId').value,
                    duswEmail: document.getElementById('duswEmail').value,
                    duswName: document.getElementById('duswName').value
                };

                const response = await fetch('https://api.transplantwizard.com/api/v1/dusw/referrals/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok || data.success === false) {
                    throw new Error(data.error || 'Failed to send referral');
                }

                const patientName = document.getElementById('patientFirstName').value + ' ' + document.getElementById('patientLastName').value;
                const patientEmail = document.getElementById('patientEmail').value;

                bootstrap.Modal.getInstance(document.getElementById('referralModal')).hide();
                
                document.getElementById('successModalPatientName').textContent = patientName;
                document.getElementById('successModalPatientEmail').textContent = patientEmail;
                new bootstrap.Modal(document.getElementById('successModal')).show();

                referralForm.reset();
            } catch (error) {
                errorMessage.textContent = error.message;
                errorAlert.classList.remove('d-none');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i><span id="submitText">Send Referral</span>';
            }
        });
    }

    document.getElementById('successDoneBtn')?.addEventListener('click', function() {
        bootstrap.Modal.getInstance(document.getElementById('successModal'))?.hide();
        window.location.reload();
    });
});

async function markAsRead(notificationId) {
    try {
        await fetch('/notifications/' + notificationId + '/read', { method: 'POST', credentials: 'same-origin' });
    } catch (error) {
        console.error('Error:', error);
    }
}

async function markAllRead() {
    try {
        await fetch('/notifications/mark-all-read', { method: 'POST', credentials: 'same-origin' });
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>

<%- include('partials/footer') %>
