<%- include('partials/header', {title: title}) %>

<!-- Main Dashboard Container -->
<div class="container-fluid px-4 py-4" style="background: #f8fafc; min-height: calc(100vh - 150px);">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h1 class="h3 fw-bold mb-1" style="color: #111827;">
                                Welcome back, <%= user.title %> <%= user.firstName %>!
                            </h1>
                            <p class="mb-0" style="color: #4b5563;">
                                <i class="fas fa-hospital me-1" style="color: #6366f1;"></i><%= user.dialysisClinic %>
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn text-white fw-semibold" data-bs-toggle="modal" data-bs-target="#referralModal" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; padding: 10px 20px;">
                                <i class="fas fa-user-plus me-2"></i>Refer New Patient
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Total Patients -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 h-100 shadow-sm" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 16px;">
                <div class="card-body p-4 text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1 text-uppercase small fw-bold" style="letter-spacing: 0.5px; color: rgba(255,255,255,0.85);">Total Patients</p>
                            <h2 class="display-4 fw-bold mb-0" style="color: white;"><%= stats.totalPatients %></h2>
                            <p class="mb-0 mt-2 small" style="color: rgba(255,255,255,0.8);">Assigned to you</p>
                        </div>
                        <div class="rounded-circle p-3" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-users fa-lg" style="color: white;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TC Selection Rate -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 h-100 shadow-sm" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px;">
                <div class="card-body p-4 text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1 text-uppercase small fw-bold" style="letter-spacing: 0.5px; color: rgba(255,255,255,0.85);">TC Selection Rate</p>
                            <h2 class="display-4 fw-bold mb-0" style="color: white;"><%= stats.tcSelectionPercent %>%</h2>
                            <p class="mb-0 mt-2 small" style="color: rgba(255,255,255,0.8);"><%= stats.patientsWithTC %> of <%= stats.totalPatients %> selected</p>
                        </div>
                        <div class="rounded-circle p-3" style="background: rgba(255,255,255,0.2);">
                            <i class="fas fa-hospital fa-lg" style="color: white;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Breakdown -->
        <div class="col-lg-4 col-md-12">
            <div class="card border-0 h-100 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <p class="mb-3 text-uppercase small fw-bold" style="letter-spacing: 0.5px; color: #374151;">
                        <i class="fas fa-chart-pie me-2" style="color: #6366f1;"></i>Patient Status Breakdown
                    </p>
                    <div class="row text-center g-2">
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: #fef3c7;">
                                <h4 class="fw-bold mb-0" style="color: #b45309;"><%= stats.statusCounts.applied %></h4>
                                <small style="color: #92400e; font-size: 0.7rem; font-weight: 500;">Applied</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: #dbeafe;">
                                <h4 class="fw-bold mb-0" style="color: #1d4ed8;"><%= stats.statusCounts.under_review %></h4>
                                <small style="color: #1e40af; font-size: 0.7rem; font-weight: 500;">Review</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: #d1fae5;">
                                <h4 class="fw-bold mb-0" style="color: #047857;"><%= stats.statusCounts.accepted %></h4>
                                <small style="color: #065f46; font-size: 0.7rem; font-weight: 500;">Accepted</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: #ede9fe;">
                                <h4 class="fw-bold mb-0" style="color: #6d28d9;"><%= stats.statusCounts.waitlisted %></h4>
                                <small style="color: #5b21b6; font-size: 0.7rem; font-weight: 500;">Waitlist</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: #fee2e2;">
                                <h4 class="fw-bold mb-0" style="color: #b91c1c;"><%= stats.statusCounts.declined %></h4>
                                <small style="color: #991b1b; font-size: 0.7rem; font-weight: 500;">Declined</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded" style="background: #f3f4f6;">
                                <h4 class="fw-bold mb-0" style="color: #374151;"><%= stats.statusCounts.no_selection %></h4>
                                <small style="color: #4b5563; font-size: 0.7rem; font-weight: 500;">Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3" style="color: #111827;"><i class="fas fa-bolt me-2" style="color: #6366f1;"></i>Quick Actions</h5>
                    <div class="d-flex gap-3 flex-wrap">
                        <button class="btn fw-semibold" data-bs-toggle="modal" data-bs-target="#referralModal" style="background: #6366f1; color: white; border: none;">
                            <i class="fas fa-user-plus me-2"></i>Refer New Patient
                        </button>
                        <a href="/patients" class="btn fw-semibold" style="background: #e0e7ff; color: #4338ca; border: none;">
                            <i class="fas fa-users me-2"></i>View All Patients
                        </a>
                        <button class="btn fw-semibold" disabled title="Coming Soon" style="background: #f3f4f6; color: #6b7280; border: none;">
                            <i class="fas fa-envelope me-2"></i>Send Message to Patient
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Notifications -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: white;">
                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #111827;">
                            <i class="fas fa-bell me-2" style="color: #6366f1;"></i>Recent Notifications
                        </h5>
                        <a href="/notifications" class="btn btn-sm fw-semibold" style="background: #e0e7ff; color: #4338ca; border: none;">
                            View All <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <% if (duswNotifications && duswNotifications.length > 0) { %>
                        <div class="list-group list-group-flush">
                            <% duswNotifications.slice(0, 5).forEach(notification => { %>
                                <a href="/patients/<%= notification.patient_id %>" class="list-group-item list-group-item-action border-0 rounded mb-2 <%= notification.is_read ? '' : 'border-start border-4' %>" style="<%= notification.is_read ? 'background: #f9fafb;' : 'background: #eef2ff; border-color: #6366f1 !important;' %>">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <% if (notification.notification_type === 'documents_complete') { %>
                                                <span class="badge rounded-circle p-2" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #d1fae5;"><i class="fas fa-file-check" style="color: #059669;"></i></span>
                                            <% } else if (notification.notification_type === 'intake_form_complete') { %>
                                                <span class="badge rounded-circle p-2" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #dbeafe;"><i class="fas fa-clipboard-check" style="color: #2563eb;"></i></span>
                                            <% } else if (notification.notification_type === 'tc_selection') { %>
                                                <span class="badge rounded-circle p-2" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #fef3c7;"><i class="fas fa-hospital" style="color: #d97706;"></i></span>
                                            <% } else { %>
                                                <span class="badge rounded-circle p-2" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #e0e7ff;"><i class="fas fa-info" style="color: #6366f1;"></i></span>
                                            <% } %>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0 fw-semibold" style="color: #111827;"><%= notification.title %></h6>
                                            <p class="mb-0 small" style="color: #6b7280;"><%= notification.message %></p>
                                        </div>
                                        <div class="text-end">
                                            <small style="color: #9ca3af;"><%= new Date(notification.created_at).toLocaleDateString() %></small>
                                            <% if (!notification.is_read) { %>
                                                <br><span class="badge mt-1" style="background: #6366f1; color: white; font-size: 0.65rem;">New</span>
                                            <% } %>
                                        </div>
                                    </div>
                                </a>
                            <% }); %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash fa-2x mb-3" style="color: #d1d5db;"></i>
                            <p style="color: #6b7280;">No notifications yet. You'll see updates when patients complete actions.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Referral Modal -->
<div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div>
                    <h5 class="modal-title text-white fw-bold mb-0" id="referralModalLabel">
                        <i class="fas fa-user-plus me-2"></i>Refer a New Patient
                    </h5>
                    <small class="text-white-50">Invite a patient to join Transplant Wizard</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="referralForm">
                    <div id="successAlert" class="alert alert-success d-none">
                        <i class="fas fa-check-circle me-2"></i>Referral sent successfully!
                    </div>
                    <div id="errorAlert" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-circle me-2"></i><span id="errorMessage"></span>
                    </div>

                    <h6 class="fw-bold mb-3" style="color: #374151;">Patient Information</h6>
                    
                    <div class="mb-3">
                        <label for="patientTitle" class="form-label small fw-semibold">Title (Optional)</label>
                        <select class="form-select form-select-sm" id="patientTitle" name="patientTitle">
                            <option value="">Select title...</option>
                            <option value="Mr">Mr</option>
                            <option value="Mrs">Mrs</option>
                            <option value="Ms">Ms</option>
                            <option value="Dr">Dr</option>
                        </select>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="patientFirstName" class="form-label small fw-semibold">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="patientFirstName" name="patientFirstName" required>
                        </div>
                        <div class="col-6">
                            <label for="patientLastName" class="form-label small fw-semibold">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="patientLastName" name="patientLastName" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="patientEmail" class="form-label small fw-semibold">Email Address <span class="text-danger">*</span></label>
                        <input type="email" class="form-control form-control-sm" id="patientEmail" name="patientEmail" required>
                    </div>

                    <div class="mb-3">
                        <label for="patientNephrologist" class="form-label small fw-semibold">Nephrologist (Optional)</label>
                        <input type="text" class="form-control form-control-sm" id="patientNephrologist" name="patientNephrologist" placeholder="Dr. Smith">
                    </div>

                    <!-- Hidden Fields -->
                    <input type="hidden" id="dialysisClinicId" name="dialysisClinicId" value="<%= user.dialysisClinicId || '' %>">
                    <input type="hidden" id="dialysisClinic" name="dialysisClinic" value="<%= user.dialysisClinic %>">
                    <input type="hidden" id="duswId" name="duswId" value="<%= user.id %>">
                    <input type="hidden" id="duswEmail" name="duswEmail" value="<%= user.email %>">
                    <input type="hidden" id="duswName" name="duswName" value="<%= user.title %> <%= user.firstName %> <%= user.lastName %>">
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReferral" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    <i class="fas fa-paper-plane me-2"></i><span id="submitText">Send Referral</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check" style="font-size: 36px; color: white;"></i>
                    </div>
                </div>
                <h4 class="fw-bold mb-3">Referral Sent!</h4>
                <p class="text-muted mb-1">Patient referral created for:</p>
                <p class="fw-semibold mb-1" id="successModalPatientName"></p>
                <p class="text-muted mb-4" id="successModalPatientEmail"></p>
                <button type="button" class="btn btn-primary px-4" id="successDoneBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const referralForm = document.getElementById('referralForm');
    const submitButton = document.getElementById('submitReferral');
    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const submitText = document.getElementById('submitText');

    if (submitButton) {
        submitButton.addEventListener('click', async function(e) {
            e.preventDefault();
            
            successAlert.classList.add('d-none');
            errorAlert.classList.add('d-none');

            if (!referralForm.checkValidity()) {
                referralForm.reportValidity();
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

            try {
                const formData = {
                    patientTitle: document.getElementById('patientTitle').value || null,
                    patientFirstName: document.getElementById('patientFirstName').value,
                    patientLastName: document.getElementById('patientLastName').value,
                    patientEmail: document.getElementById('patientEmail').value,
                    patientNephrologist: document.getElementById('patientNephrologist').value || null,
                    dialysisClinicId: document.getElementById('dialysisClinicId').value,
                    dialysisClinicName: document.getElementById('dialysisClinic').value,
                    duswId: document.getElementById('duswId').value,
                    duswEmail: document.getElementById('duswEmail').value,
                    duswName: document.getElementById('duswName').value
                };

                const response = await fetch('https://api.transplantwizard.com/api/v1/dusw/referrals/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok || data.success === false) {
                    throw new Error(data.error || 'Failed to send referral');
                }

                const patientName = document.getElementById('patientFirstName').value + ' ' + document.getElementById('patientLastName').value;
                const patientEmail = document.getElementById('patientEmail').value;

                bootstrap.Modal.getInstance(document.getElementById('referralModal')).hide();
                
                document.getElementById('successModalPatientName').textContent = patientName;
                document.getElementById('successModalPatientEmail').textContent = patientEmail;
                new bootstrap.Modal(document.getElementById('successModal')).show();

                referralForm.reset();
            } catch (error) {
                errorMessage.textContent = error.message;
                errorAlert.classList.remove('d-none');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i><span id="submitText">Send Referral</span>';
            }
        });
    }

    document.getElementById('successDoneBtn')?.addEventListener('click', function() {
        bootstrap.Modal.getInstance(document.getElementById('successModal'))?.hide();
        window.location.reload();
    });
});

async function markAsRead(notificationId) {
    try {
        await fetch('/notifications/' + notificationId + '/read', { method: 'POST', credentials: 'same-origin' });
    } catch (error) {
        console.error('Error:', error);
    }
}

async function markAllRead() {
    try {
        await fetch('/notifications/mark-all-read', { method: 'POST', credentials: 'same-origin' });
        location.reload();
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>

<%- include('partials/footer') %>
